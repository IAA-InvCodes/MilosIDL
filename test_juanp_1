pro test_juanp_1

loadct,0
colores

;************************PHYSICS CONSTANTS (INITIAL)******************
B1=0.2 & B2=0.8
eta0=8.5d0
Magnet=2600.
GAMMA=20.
AZI=20.
vlos=0.25  ;km/s
MACRO=0.
LANDADOPP=0.090
aa=0.08
alfa=0.
INIT_MODEL=[eta0,magnet,vlos,landadopp,aa,gamma,azi,B1,B2,macro,alfa]
;**********************************************************
init_milos,'6173',wl

;wavelength axis
Init_landa=Wl(1)-0.5
step=10d0
Points=100.
STEP=STEP/1000d0
axis=Init_landa+Dindgen(Points)*step

INIT_MODEL[1]=100d0
milos, Wl, axis, init_model, y, /synthesis, /doplot
milos, Wl, axis, init_model, y, rfs=rfs, /doplot
milos, Wl, axis, init_model, y, rfs=rfs_n, /doplot,/numerical
setpscf,filename='B100.ps'
!p.multi=[0,9,4]
for j=0,3 do for i=0,8 do begin & plot,rfs[*,i,j],chars=0.6 & oplot, rfs_n[*,i,j],line=2,color=3 & endfor
endpscf
INIT_MODEL[1]=1000d0
milos, Wl, axis, init_model, y, /synthesis, /doplot
milos, Wl, axis, init_model, y, rfs=rfs, /doplot
milos, Wl, axis, init_model, y, rfs=rfs_n, /doplot,/numerical
setpscf,filename='B1000.ps'
!p.multi=[0,9,4]
for j=0,3 do for i=0,8 do begin & plot,rfs[*,i,j],chars=0.6 & oplot, rfs_n[*,i,j],line=2,color=3 & endfor
endpscf
INIT_MODEL[1]=2000d0
milos, Wl, axis, init_model, y, /synthesis, /doplot
milos, Wl, axis, init_model, y, rfs=rfs, /doplot
milos, Wl, axis, init_model, y, rfs=rfs_n, /doplot,/numerical
setpscf,filename='B2000.ps'
!p.multi=[0,9,4]
for j=0,3 do for i=0,8 do begin & plot,rfs[*,i,j],chars=0.6 & oplot, rfs_n[*,i,j],line=2,color=3 & endfor
endpscf
INIT_MODEL[1]=3000d0
milos, Wl, axis, init_model, y, /synthesis, /doplot
milos, Wl, axis, init_model, y, rfs=rfs, /doplot
milos, Wl, axis, init_model, y, rfs=rfs_n, /doplot,/numerical
setpscf,filename='B3000.ps'
!p.multi=[0,9,4]
for j=0,3 do for i=0,8 do begin & plot,rfs[*,i,j],chars=0.6 & oplot, rfs_n[*,i,j],line=2,color=3 & endfor
endpscf

STOP

!p.multi=[0,2,2]

for i=1,4 do for j=1,1 do begin & plot,rfs[*,i,j] & oplot, rfs_n[*,i,j],line=2,color=3 & endfor

STOP

OLD=INIT_MODEL
;Init model inversion
B1=0.3 & B2=0.7
eta0=6d0
Magnet=100.
GAMMA=90.
AZI=60.
vlos=2.25  ;km/s
MACRO=1.8
LANDADOPP=0.01
aa=0.03
alfa=0.
INIT_MODEL=[eta0,magnet,vlos,landadopp,aa,gamma,azi,B1,B2,macro,alfa]

fix=[1.,1.,1.,1.,1.,1.,1.,1.,1.,1.,0.]
weight=[1.,1.,1.,1.]


INIT_MODEL=[eta0,magnet,vlos,landadopp,aa,gamma,azi,B1,B2,macro,alfa]
milos, wl, axis, init_model, y, yfit=yfit,$
  fix=fix,/inversion,miter=100,noise=1.d-6,/doplot,/numerical

Print,'Old model:' , OLD
Print,'New model:' , init_model

STOP
end
